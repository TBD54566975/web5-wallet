{"version":3,"names":["Symbol","iterator","ExpoLevelIterator","AbstractIterator","constructor","db","options","level","_db","it","newIterator","hasLimit","limit","undefined","isReversed","reverse","readsKeys","keys","readsValues","values","lowerBound","upperBound","lowerBoundIsOpen","upperBoundIsOpen","gt","gte","lt","lte","startingBound","startingBoundIsOpen","seek","toBuffer","valid","comparison","compareKey","prev","next","seekLast","seekToFirst","endingBound","endingBoundIsOpen","item","close","current","isEnded","key","keyBuf","val","valueBuf","_next","callback","busy","ModuleError","code","gotKey","gotValue","startedReading","fromBuffer","nextTick","e","_seek","target","_close","_openIterators","delete","stepCount","ExpoLevel","AbstractLevel","location","encodings","streams","createIfMissing","errorIfExists","permanence","snapshots","Set","_open","realLocation","fs","documentDirectory","info","getInfoAsync","exists","message","LevelDB","msg","includes","err","console","log","size","closed","_get","value","getBuf","error","_getMany","map","_put","put","_del","_batch","operations","operation","type","_iterator","add","_clear","_clear_inner","kv","push","k","then","catch","Error","array","buffer","slice","byteOffset","byteLength","buf","Uint8Array"],"sources":["level.ts"],"sourcesContent":["import {\n  AbstractBatchOperation,\n  AbstractBatchOptions,\n  AbstractClearOptions,\n  AbstractDatabaseOptions,\n  AbstractDelOptions,\n  AbstractGetManyOptions,\n  AbstractGetOptions,\n  AbstractIterator,\n  AbstractIteratorOptions,\n  AbstractLevel,\n  AbstractOpenOptions,\n  AbstractPutOptions,\n  AbstractSeekOptions,\n  NodeCallback\n} from 'abstract-level';\nimport {LevelDB, LevelDBIterator} from 'react-native-leveldb';\nimport ModuleError from 'module-error';\nimport type {NextCallback} from 'abstract-level/types/abstract-iterator';\nimport * as fs from \"expo-file-system\";\n\nexport class ExpoLevelIterator<K, V> extends AbstractIterator<ExpoLevel<K, V>, Uint8Array, Uint8Array> {\n  it: LevelDBIterator;\n  valid: boolean = true;\n  options: AbstractIteratorOptions<Uint8Array, Uint8Array>;\n  hasLimit: boolean;\n  isReversed: boolean;\n  readsKeys: boolean;\n  readsValues: boolean;\n  startingBoundIsOpen: boolean = false;\n  endingBoundIsOpen: boolean = false;\n  stepCount = 0;\n  startingBound?: Uint8Array;\n  endingBound?: Uint8Array;\n\n  busy = false;\n\n  startedReading = false;\n\n  constructor(db: any, options: AbstractIteratorOptions<Uint8Array, Uint8Array>) {\n    super(db, options);\n    const level = this.db._db!;\n    // console.log('iterator options was', options);\n    this.it = level.newIterator();\n    this.options = options;\n    this.hasLimit = (options.limit != undefined) && (options.limit != -1);\n    this.isReversed = options.reverse || false;\n    this.readsKeys = (options.keys != undefined ? options.keys : true);\n    this.readsValues = (options.values != undefined) ? options.values : true;\n\n    let lowerBound: Uint8Array | undefined;\n    let upperBound: Uint8Array | undefined;\n    let lowerBoundIsOpen = true;\n    let upperBoundIsOpen = true;\n\n    // Counter-intuitively, you don't need to check if gt >= gte, or lt <= lte\n    // Because according to the test suite... there's a priority!\n    // gte has higher priority than gt, and lte has higher priority than lt!\n    // so we just check them later that's all\n    if (options.gt != undefined) {\n      lowerBound = options.gt;\n      lowerBoundIsOpen = false;\n    }\n    if (options.gte != undefined) {\n      lowerBound = options.gte;\n      lowerBoundIsOpen = true;\n    }\n    if (options.lt != undefined) {\n      upperBound = options.lt;\n      upperBoundIsOpen = false;\n    }\n    if (options.lte != undefined) {\n      upperBound = options.lte;\n      upperBoundIsOpen = true;\n    }\n    // }\n    const startingBound = options.reverse ? upperBound : lowerBound;\n    if (startingBound != undefined) {\n      this.startingBoundIsOpen = this.isReversed ? upperBoundIsOpen : lowerBoundIsOpen;\n      this.it.seek(toBuffer(startingBound));\n      this.startingBound = startingBound;\n      if (this.it.valid()) {\n        const comparison = this.it.compareKey(toBuffer(startingBound));\n        if ((!(this.isReversed ? upperBoundIsOpen : lowerBoundIsOpen) && comparison == 0) || (this.isReversed && comparison > 0)) {\n          this.isReversed ? this.it.prev() : this.it.next();\n        }\n      } else if (this.isReversed) {\n        // We must have seeked past the end.\n        this.it.seekLast();\n      }\n    } else {\n      if (this.isReversed) {\n        this.it.seekLast();\n      } else {\n        // Just... assume it's at first?\n        this.it.seekToFirst();\n      }\n      // this.isReversed ? this.it.seekLast() : this.it.seekToFirst();\n    }\n\n    const endingBound = options.reverse ? lowerBound : upperBound;\n    if (endingBound != undefined) {\n      this.endingBoundIsOpen = this.isReversed ? lowerBoundIsOpen : upperBoundIsOpen;\n      this.endingBound = endingBound;\n      // self.endingSliceStorage = ...\n    } else {\n      // nothing?\n      // self.endingSliceStorage = NULL\n    }\n  }\n\n  async* [Symbol.iterator]() {\n    try {\n      let item\n\n      while ((item = (await this.next())) !== undefined) {\n        yield item\n      }\n    } finally {\n      if (this.valid) await this.close()\n    }\n  }\n\n  current(): [ArrayBuffer | undefined, ArrayBuffer | undefined] | undefined {\n    if (this.isEnded()) {\n      return undefined;\n    }\n    let key: ArrayBuffer | undefined = this.readsKeys ? this.it.keyBuf() : undefined;\n    let val: ArrayBuffer | undefined = this.readsValues ? this.it.valueBuf() : undefined;\n    return [key, val];\n  }\n\n  // An empty array signifies the natural end of the iterator\n  // so simply yielding a non-empty array signifies non-end\n  protected _next(callback: NextCallback<Uint8Array, Uint8Array>): void {\n    if (this.busy) {\n      callback(new ModuleError('Iterator is busy', {code: 'LEVEL_ITERATOR_BUSY'}));\n      return;\n    } else if (!this.valid) {\n      callback(new ModuleError('Iterator is not open', {code: 'LEVEL_ITERATOR_NOT_OPEN'}));\n      return;\n    }\n    // need to set busy to pass compliance\n    this.busy = true;\n    try {\n      let gotKey: Uint8Array | undefined;\n      let gotValue: Uint8Array | undefined;\n\n      if (this.it.valid()) {\n        // If already started reading, then next() should move the iterator\n        if (this.startedReading) {\n          if (this.options.reverse) {\n            this.it.prev();\n          } else {\n            this.it.next();\n          }\n        } else {\n          // never started reading yet; just use the same pos.\n          this.startedReading = true;\n        }\n        if (this.isEnded()) {\n          gotKey = undefined;\n          gotValue = undefined;\n        } else {\n          if (this.readsKeys) {\n            gotKey = fromBuffer(this.it.keyBuf());\n          }\n          if (this.readsValues) {\n            gotValue = fromBuffer(this.it.valueBuf());\n          }\n        }\n      } else {\n        gotKey = undefined;\n        gotValue = undefined;\n      }\n      this.db.nextTick(callback, null, gotKey, gotValue);\n      this.busy = false;\n    } catch (e) {\n      this.busy = false;\n      this.db.nextTick(callback, e);\n    }\n  }\n\n  protected _seek(target: Uint8Array, options: AbstractSeekOptions<Uint8Array>): void {\n    if (!this.valid) {\n      return;\n    }\n    // Reference : https://github.com/andymatuschak/react-native-leveldown/blob/e7d14cfdf81558d15ecec76e956269081d12a40b/ios/RNLeveldown.mm#L388\n    this.it.seek(toBuffer(target));\n    if (this.isReversed) {\n      if (!this.it.valid()) {\n        // We must have seeked past the end.\n        this.it.seekLast();\n      }\n      // TODO: Change this back once package is patched\n      else if (this.it.compareKey(toBuffer(target)) > 0) {\n        // We seeked past the target; step back.\n        if (this.isReversed) {\n          this.it.prev();\n        } else {\n          this.it.next();\n        }\n      }\n    }\n    this.startedReading = false;\n  }\n\n  protected _close(callback: NodeCallback<void>): void {\n    if (!this.valid) return;\n\n    this.valid = false;\n    this.it.close();\n    this.db._openIterators.delete(this);\n    this.db.nextTick(callback);\n  }\n\n  protected isEnded(): boolean {\n    // following https://github.com/andymatuschak/react-native-leveldown/blob/e7d14cfdf81558d15ecec76e956269081d12a40b/ios/RNLeveldown.mm#L162\n    if (!this.it.valid()) {\n      return true;\n    }\n    if (this.hasLimit && this.stepCount >= this.limit) {\n      return true;\n    }\n    if (this.endingBound != undefined) {\n      const comparison = this.it.compareKey(toBuffer(this.endingBound))\n      if ((comparison < 0 && this.isReversed) || (comparison > 0 && !this.isReversed) || (comparison == 0 && !this.endingBoundIsOpen)) {\n        return true;\n      }\n    }\n    if (this.startingBound != undefined) {\n      const comparison = this.it.compareKey(toBuffer(this.startingBound));\n      if ((comparison > 0 && this.isReversed) || (comparison < 0 && !this.isReversed) || (comparison == 0 && !this.startingBoundIsOpen)) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n\n\nexport class ExpoLevel<K, V> extends AbstractLevel<Uint8Array, K, V> {\n  _db?: LevelDB;\n  location: string;\n  _openIterators: Set<ExpoLevelIterator<K, V>> = new Set();\n\n  constructor(\n    location: string,\n    options?: AbstractDatabaseOptions<K, V> | undefined\n  ) {\n    super({\n      encodings: {\n        \"view\": true\n      },\n      seek: true,\n      streams: false,\n      createIfMissing: true,\n      errorIfExists: true,\n      permanence: true,\n      snapshots: false,\n    }, options);\n\n    this.location = location;\n  }\n\n  protected async _open(options: AbstractOpenOptions, callback: NodeCallback<void>): Promise<void> {\n    const {\n      createIfMissing = true, errorIfExists = false\n    } = options;\n    try {\n      if (errorIfExists) {\n        // sometimes the LevelDB cannot report error for errorIfExists\n        const realLocation = fs.documentDirectory + this.location;\n        const info = await fs.getInfoAsync(realLocation)\n\n        if (info.exists) {\n          throw {message: 'File already exists'};\n        }\n      }\n\n      this._db = new LevelDB(this.location, createIfMissing, errorIfExists);\n      this.nextTick(callback, null);\n    } catch (e: any) {\n      const msg = ((e as any).message as string);\n      if (msg.includes('does not exist')) {\n        const err = new ModuleError(msg, {code: 'LEVEL_DATABASE_NOT_OPEN'})\n        // console.log('msg has does not exist');\n        this.nextTick(callback, err);\n      } else if (msg.includes('exists')) {\n        const err = new ModuleError(msg, {code: 'LEVEL_DATABASE_NOT_OPEN'})\n        // console.log('msg has already exists');\n        this.nextTick(callback, err);\n        // this.nextTick(callback, e);\n      } else {\n        console.log('open error', 'type', typeof e, e.code, e.message);\n        throw e;\n      }\n    }\n  }\n\n  protected _close(callback: NodeCallback<void>): void {\n    try {\n      if (this._openIterators.size) {\n        for (const it of this._openIterators) {\n          it.valid = false;\n          it.it.close();\n        }\n      }\n      if (!this._db!.closed) {\n        this._db!.close();\n      }\n      this.nextTick(callback, null);\n    } catch (e) {\n      this.nextTick(callback, e);\n    }\n  }\n\n  protected _get(\n    key: Uint8Array,\n    options: AbstractGetOptions<K, V>,\n    callback: NodeCallback<Uint8Array>\n  ): void {\n    this.nextTick(() => {\n      try {\n        const value = this._db!.getBuf(toBuffer(key));\n        if (value === null) { // not found\n          callback(new ModuleError(`Key ${key} was not found`, {code: 'LEVEL_NOT_FOUND'}));\n          return;\n        }\n        callback(null, fromBuffer(value));\n      } catch (e) {\n        callback(error(e));\n      }\n    })\n  }\n\n  protected _getMany(\n    keys: Uint8Array[],\n    options: AbstractGetManyOptions<K, V>,\n    callback: NodeCallback<(Uint8Array | undefined)[]>\n  ): void {\n    this.nextTick(() => {\n      try {\n        const values = keys.map((key) => {\n          const value = this._db!.getBuf(toBuffer(key));\n          if (value === null) { // not found\n            return undefined;\n          } else {\n            return fromBuffer(value);\n          }\n        });\n        callback(null, values);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _put(\n    key: Uint8Array,\n    value: Uint8Array,\n    options: AbstractPutOptions<K, V>,\n    callback: NodeCallback<void>\n  ): void {\n    this.nextTick(() => {\n      try {\n        this._db!.put(toBuffer(key), toBuffer(value));\n        callback(undefined);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _del(\n    key: Uint8Array, options: AbstractDelOptions<K>, callback: NodeCallback<void>\n  ): void {\n    this.nextTick(() => {\n      try {\n        this._db!.delete(toBuffer(key));\n        callback(undefined);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _batch(\n    operations: Array<AbstractBatchOperation<unknown, Uint8Array, Uint8Array>>,\n    options: AbstractBatchOptions<K, V>,\n    callback: NodeCallback<void>\n  ): void {\n    // TODO: Maybe see if we can add batch to actual react-native-leveldb?\n    // Or just doing this is enough...\n\n    this.nextTick(() => {\n      try {\n        for (const operation of operations) {\n          switch (operation.type) {\n            case \"put\":\n              this._db!.put(toBuffer(operation.key), toBuffer(operation.value));\n              break;\n            case \"del\":\n              this._db!.delete(toBuffer(operation.key));\n              break;\n          }\n        }\n        callback(undefined);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _iterator(options: AbstractIteratorOptions<Uint8Array, Uint8Array>) {\n    const it = new ExpoLevelIterator<K, V>(this, options);\n    this._openIterators.add(it);\n    return it;\n  }\n\n  // Hopefully can do this better later with native implementaion?\n  _clear(options: AbstractClearOptions<K>, callback: NodeCallback<void>) {\n    const _clear_inner = async () => {\n      const it = this.iterator({...options, values: false});\n      try {\n        const keys: Uint8Array[] = [];\n        while (true) {\n          const kv = await it.next();\n          if (!kv) {\n            break;\n          }\n          keys.push(kv[0] as any as Uint8Array);\n        }\n\n        for (const k of keys) {\n          this._db!.delete(toBuffer(k));\n        }\n      } finally {\n        await it.close();\n      }\n    }\n\n    _clear_inner().then(() => {\n      callback(undefined)\n    }).catch((e) => {\n      callback(error(e))\n    });\n  }\n}\n\nfunction error(e: unknown): Error {\n  if (e instanceof Error) {\n    return e;\n  }\n\n  return new Error(`${e}`);\n}\n\nfunction toBuffer(array: Uint8Array): ArrayBuffer {\n  return array.buffer.slice(\n    array.byteOffset,\n    array.byteLength + array.byteOffset\n  );\n}\n\nfunction fromBuffer(buf: ArrayBuffer): Uint8Array {\n  return new Uint8Array(buf);\n}\n"],"mappings":"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"}