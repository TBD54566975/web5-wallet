{"version":3,"names":["AbstractIterator","AbstractLevel","LevelDB","ModuleError","fs","Symbol","iterator","ExpoLevelIterator","constructor","db","options","level","_db","it","newIterator","hasLimit","limit","undefined","isReversed","reverse","readsKeys","keys","readsValues","values","lowerBound","upperBound","lowerBoundIsOpen","upperBoundIsOpen","gt","gte","lt","lte","startingBound","startingBoundIsOpen","seek","toBuffer","valid","comparison","compareKey","prev","next","seekLast","seekToFirst","endingBound","endingBoundIsOpen","item","close","current","isEnded","key","keyBuf","val","valueBuf","_next","callback","busy","code","gotKey","gotValue","startedReading","fromBuffer","nextTick","e","_seek","target","_close","_openIterators","delete","stepCount","ExpoLevel","location","encodings","streams","createIfMissing","errorIfExists","permanence","snapshots","Set","_open","realLocation","documentDirectory","info","getInfoAsync","exists","message","msg","includes","err","console","log","size","closed","_get","value","getBuf","error","_getMany","map","_put","put","_del","_batch","operations","operation","type","_iterator","add","_clear","_clear_inner","kv","push","k","then","catch","Error","array","buffer","slice","byteOffset","byteLength","buf","Uint8Array"],"sources":["level.ts"],"sourcesContent":["import {\n  AbstractBatchOperation,\n  AbstractBatchOptions,\n  AbstractClearOptions,\n  AbstractDatabaseOptions,\n  AbstractDelOptions,\n  AbstractGetManyOptions,\n  AbstractGetOptions,\n  AbstractIterator,\n  AbstractIteratorOptions,\n  AbstractLevel,\n  AbstractOpenOptions,\n  AbstractPutOptions,\n  AbstractSeekOptions,\n  NodeCallback\n} from 'abstract-level';\nimport {LevelDB, LevelDBIterator} from 'react-native-leveldb';\nimport ModuleError from 'module-error';\nimport type {NextCallback} from 'abstract-level/types/abstract-iterator';\nimport * as fs from \"expo-file-system\";\n\nexport class ExpoLevelIterator<K, V> extends AbstractIterator<ExpoLevel<K, V>, Uint8Array, Uint8Array> {\n  it: LevelDBIterator;\n  valid: boolean = true;\n  options: AbstractIteratorOptions<Uint8Array, Uint8Array>;\n  hasLimit: boolean;\n  isReversed: boolean;\n  readsKeys: boolean;\n  readsValues: boolean;\n  startingBoundIsOpen: boolean = false;\n  endingBoundIsOpen: boolean = false;\n  stepCount = 0;\n  startingBound?: Uint8Array;\n  endingBound?: Uint8Array;\n\n  busy = false;\n\n  startedReading = false;\n\n  constructor(db: any, options: AbstractIteratorOptions<Uint8Array, Uint8Array>) {\n    super(db, options);\n    const level = this.db._db!;\n    // console.log('iterator options was', options);\n    this.it = level.newIterator();\n    this.options = options;\n    this.hasLimit = (options.limit != undefined) && (options.limit != -1);\n    this.isReversed = options.reverse || false;\n    this.readsKeys = (options.keys != undefined ? options.keys : true);\n    this.readsValues = (options.values != undefined) ? options.values : true;\n\n    let lowerBound: Uint8Array | undefined;\n    let upperBound: Uint8Array | undefined;\n    let lowerBoundIsOpen = true;\n    let upperBoundIsOpen = true;\n\n    // Counter-intuitively, you don't need to check if gt >= gte, or lt <= lte\n    // Because according to the test suite... there's a priority!\n    // gte has higher priority than gt, and lte has higher priority than lt!\n    // so we just check them later that's all\n    if (options.gt != undefined) {\n      lowerBound = options.gt;\n      lowerBoundIsOpen = false;\n    }\n    if (options.gte != undefined) {\n      lowerBound = options.gte;\n      lowerBoundIsOpen = true;\n    }\n    if (options.lt != undefined) {\n      upperBound = options.lt;\n      upperBoundIsOpen = false;\n    }\n    if (options.lte != undefined) {\n      upperBound = options.lte;\n      upperBoundIsOpen = true;\n    }\n    // }\n    const startingBound = options.reverse ? upperBound : lowerBound;\n    if (startingBound != undefined) {\n      this.startingBoundIsOpen = this.isReversed ? upperBoundIsOpen : lowerBoundIsOpen;\n      this.it.seek(toBuffer(startingBound));\n      this.startingBound = startingBound;\n      if (this.it.valid()) {\n        const comparison = this.it.compareKey(toBuffer(startingBound));\n        if ((!(this.isReversed ? upperBoundIsOpen : lowerBoundIsOpen) && comparison == 0) || (this.isReversed && comparison > 0)) {\n          this.isReversed ? this.it.prev() : this.it.next();\n        }\n      } else if (this.isReversed) {\n        // We must have seeked past the end.\n        this.it.seekLast();\n      }\n    } else {\n      if (this.isReversed) {\n        this.it.seekLast();\n      } else {\n        // Just... assume it's at first?\n        this.it.seekToFirst();\n      }\n      // this.isReversed ? this.it.seekLast() : this.it.seekToFirst();\n    }\n\n    const endingBound = options.reverse ? lowerBound : upperBound;\n    if (endingBound != undefined) {\n      this.endingBoundIsOpen = this.isReversed ? lowerBoundIsOpen : upperBoundIsOpen;\n      this.endingBound = endingBound;\n      // self.endingSliceStorage = ...\n    } else {\n      // nothing?\n      // self.endingSliceStorage = NULL\n    }\n  }\n\n  async* [Symbol.iterator]() {\n    try {\n      let item\n\n      while ((item = (await this.next())) !== undefined) {\n        yield item\n      }\n    } finally {\n      if (this.valid) await this.close()\n    }\n  }\n\n  current(): [ArrayBuffer | undefined, ArrayBuffer | undefined] | undefined {\n    if (this.isEnded()) {\n      return undefined;\n    }\n    let key: ArrayBuffer | undefined = this.readsKeys ? this.it.keyBuf() : undefined;\n    let val: ArrayBuffer | undefined = this.readsValues ? this.it.valueBuf() : undefined;\n    return [key, val];\n  }\n\n  // An empty array signifies the natural end of the iterator\n  // so simply yielding a non-empty array signifies non-end\n  protected _next(callback: NextCallback<Uint8Array, Uint8Array>): void {\n    if (this.busy) {\n      callback(new ModuleError('Iterator is busy', {code: 'LEVEL_ITERATOR_BUSY'}));\n      return;\n    } else if (!this.valid) {\n      callback(new ModuleError('Iterator is not open', {code: 'LEVEL_ITERATOR_NOT_OPEN'}));\n      return;\n    }\n    // need to set busy to pass compliance\n    this.busy = true;\n    try {\n      let gotKey: Uint8Array | undefined;\n      let gotValue: Uint8Array | undefined;\n\n      if (this.it.valid()) {\n        // If already started reading, then next() should move the iterator\n        if (this.startedReading) {\n          if (this.options.reverse) {\n            this.it.prev();\n          } else {\n            this.it.next();\n          }\n        } else {\n          // never started reading yet; just use the same pos.\n          this.startedReading = true;\n        }\n        if (this.isEnded()) {\n          gotKey = undefined;\n          gotValue = undefined;\n        } else {\n          if (this.readsKeys) {\n            gotKey = fromBuffer(this.it.keyBuf());\n          }\n          if (this.readsValues) {\n            gotValue = fromBuffer(this.it.valueBuf());\n          }\n        }\n      } else {\n        gotKey = undefined;\n        gotValue = undefined;\n      }\n      this.db.nextTick(callback, null, gotKey, gotValue);\n      this.busy = false;\n    } catch (e) {\n      this.busy = false;\n      this.db.nextTick(callback, e);\n    }\n  }\n\n  protected _seek(target: Uint8Array, options: AbstractSeekOptions<Uint8Array>): void {\n    if (!this.valid) {\n      return;\n    }\n    // Reference : https://github.com/andymatuschak/react-native-leveldown/blob/e7d14cfdf81558d15ecec76e956269081d12a40b/ios/RNLeveldown.mm#L388\n    this.it.seek(toBuffer(target));\n    if (this.isReversed) {\n      if (!this.it.valid()) {\n        // We must have seeked past the end.\n        this.it.seekLast();\n      }\n      // TODO: Change this back once package is patched\n      else if (this.it.compareKey(toBuffer(target)) > 0) {\n        // We seeked past the target; step back.\n        if (this.isReversed) {\n          this.it.prev();\n        } else {\n          this.it.next();\n        }\n      }\n    }\n    this.startedReading = false;\n  }\n\n  protected _close(callback: NodeCallback<void>): void {\n    if (!this.valid) return;\n\n    this.valid = false;\n    this.it.close();\n    this.db._openIterators.delete(this);\n    this.db.nextTick(callback);\n  }\n\n  protected isEnded(): boolean {\n    // following https://github.com/andymatuschak/react-native-leveldown/blob/e7d14cfdf81558d15ecec76e956269081d12a40b/ios/RNLeveldown.mm#L162\n    if (!this.it.valid()) {\n      return true;\n    }\n    if (this.hasLimit && this.stepCount >= this.limit) {\n      return true;\n    }\n    if (this.endingBound != undefined) {\n      const comparison = this.it.compareKey(toBuffer(this.endingBound))\n      if ((comparison < 0 && this.isReversed) || (comparison > 0 && !this.isReversed) || (comparison == 0 && !this.endingBoundIsOpen)) {\n        return true;\n      }\n    }\n    if (this.startingBound != undefined) {\n      const comparison = this.it.compareKey(toBuffer(this.startingBound));\n      if ((comparison > 0 && this.isReversed) || (comparison < 0 && !this.isReversed) || (comparison == 0 && !this.startingBoundIsOpen)) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n\n\nexport class ExpoLevel<K, V> extends AbstractLevel<Uint8Array, K, V> {\n  _db?: LevelDB;\n  location: string;\n  _openIterators: Set<ExpoLevelIterator<K, V>> = new Set();\n\n  constructor(\n    location: string,\n    options?: AbstractDatabaseOptions<K, V> | undefined\n  ) {\n    super({\n      encodings: {\n        \"view\": true\n      },\n      seek: true,\n      streams: false,\n      createIfMissing: true,\n      errorIfExists: true,\n      permanence: true,\n      snapshots: false,\n    }, options);\n\n    this.location = location;\n  }\n\n  protected async _open(options: AbstractOpenOptions, callback: NodeCallback<void>): Promise<void> {\n    const {\n      createIfMissing = true, errorIfExists = false\n    } = options;\n    try {\n      if (errorIfExists) {\n        // sometimes the LevelDB cannot report error for errorIfExists\n        const realLocation = fs.documentDirectory + this.location;\n        const info = await fs.getInfoAsync(realLocation)\n\n        if (info.exists) {\n          throw {message: 'File already exists'};\n        }\n      }\n\n      this._db = new LevelDB(this.location, createIfMissing, errorIfExists);\n      this.nextTick(callback, null);\n    } catch (e: any) {\n      const msg = ((e as any).message as string);\n      if (msg.includes('does not exist')) {\n        const err = new ModuleError(msg, {code: 'LEVEL_DATABASE_NOT_OPEN'})\n        // console.log('msg has does not exist');\n        this.nextTick(callback, err);\n      } else if (msg.includes('exists')) {\n        const err = new ModuleError(msg, {code: 'LEVEL_DATABASE_NOT_OPEN'})\n        // console.log('msg has already exists');\n        this.nextTick(callback, err);\n        // this.nextTick(callback, e);\n      } else {\n        console.log('open error', 'type', typeof e, e.code, e.message);\n        throw e;\n      }\n    }\n  }\n\n  protected _close(callback: NodeCallback<void>): void {\n    try {\n      if (this._openIterators.size) {\n        for (const it of this._openIterators) {\n          it.valid = false;\n          it.it.close();\n        }\n      }\n      if (!this._db!.closed) {\n        this._db!.close();\n      }\n      this.nextTick(callback, null);\n    } catch (e) {\n      this.nextTick(callback, e);\n    }\n  }\n\n  protected _get(\n    key: Uint8Array,\n    options: AbstractGetOptions<K, V>,\n    callback: NodeCallback<Uint8Array>\n  ): void {\n    this.nextTick(() => {\n      try {\n        const value = this._db!.getBuf(toBuffer(key));\n        if (value === null) { // not found\n          callback(new ModuleError(`Key ${key} was not found`, {code: 'LEVEL_NOT_FOUND'}));\n          return;\n        }\n        callback(null, fromBuffer(value));\n      } catch (e) {\n        callback(error(e));\n      }\n    })\n  }\n\n  protected _getMany(\n    keys: Uint8Array[],\n    options: AbstractGetManyOptions<K, V>,\n    callback: NodeCallback<(Uint8Array | undefined)[]>\n  ): void {\n    this.nextTick(() => {\n      try {\n        const values = keys.map((key) => {\n          const value = this._db!.getBuf(toBuffer(key));\n          if (value === null) { // not found\n            return undefined;\n          } else {\n            return fromBuffer(value);\n          }\n        });\n        callback(null, values);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _put(\n    key: Uint8Array,\n    value: Uint8Array,\n    options: AbstractPutOptions<K, V>,\n    callback: NodeCallback<void>\n  ): void {\n    this.nextTick(() => {\n      try {\n        this._db!.put(toBuffer(key), toBuffer(value));\n        callback(undefined);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _del(\n    key: Uint8Array, options: AbstractDelOptions<K>, callback: NodeCallback<void>\n  ): void {\n    this.nextTick(() => {\n      try {\n        this._db!.delete(toBuffer(key));\n        callback(undefined);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _batch(\n    operations: Array<AbstractBatchOperation<unknown, Uint8Array, Uint8Array>>,\n    options: AbstractBatchOptions<K, V>,\n    callback: NodeCallback<void>\n  ): void {\n    // TODO: Maybe see if we can add batch to actual react-native-leveldb?\n    // Or just doing this is enough...\n\n    this.nextTick(() => {\n      try {\n        for (const operation of operations) {\n          switch (operation.type) {\n            case \"put\":\n              this._db!.put(toBuffer(operation.key), toBuffer(operation.value));\n              break;\n            case \"del\":\n              this._db!.delete(toBuffer(operation.key));\n              break;\n          }\n        }\n        callback(undefined);\n      } catch (e) {\n        callback(error(e));\n      }\n    });\n  }\n\n  protected _iterator(options: AbstractIteratorOptions<Uint8Array, Uint8Array>) {\n    const it = new ExpoLevelIterator<K, V>(this, options);\n    this._openIterators.add(it);\n    return it;\n  }\n\n  // Hopefully can do this better later with native implementaion?\n  _clear(options: AbstractClearOptions<K>, callback: NodeCallback<void>) {\n    const _clear_inner = async () => {\n      const it = this.iterator({...options, values: false});\n      try {\n        const keys: Uint8Array[] = [];\n        while (true) {\n          const kv = await it.next();\n          if (!kv) {\n            break;\n          }\n          keys.push(kv[0] as any as Uint8Array);\n        }\n\n        for (const k of keys) {\n          this._db!.delete(toBuffer(k));\n        }\n      } finally {\n        await it.close();\n      }\n    }\n\n    _clear_inner().then(() => {\n      callback(undefined)\n    }).catch((e) => {\n      callback(error(e))\n    });\n  }\n}\n\nfunction error(e: unknown): Error {\n  if (e instanceof Error) {\n    return e;\n  }\n\n  return new Error(`${e}`);\n}\n\nfunction toBuffer(array: Uint8Array): ArrayBuffer {\n  return array.buffer.slice(\n    array.byteOffset,\n    array.byteLength + array.byteOffset\n  );\n}\n\nfunction fromBuffer(buf: ArrayBuffer): Uint8Array {\n  return new Uint8Array(buf);\n}\n"],"mappings":"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"}